<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="587"/>
<h1>第11章 Android 线程和线程池</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/8/29 19:52</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2017/8/29 20:57</i></td></tr>
<tr><td><b>标签：</b></td><td><i>Android 开发艺术探索</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://tom510230.gitbooks.io/android_ka_fa_yi_shu_tan_suo/content/chapter11.html"><i>https://tom510230.gitbooks.io/android_ka_fa_yi_shu_tan_suo/content/chapter11.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div><b><span style="font-size: 24px;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">11 Android的线程和线程池</span></span></span></b></div><div><b><span style="font-size: 24px;"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></b></div><div style="-evernote-webclip:true"><div style="display: inline-block;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; text-size-adjust: 100%;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; text-size-adjust: 100%; text-rendering: optimizeLegibility; letter-spacing: 0.2px;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; background: rgb(255, 255, 255); transition: none;"><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;text-size-adjust:none;-webkit-font-smoothing:antialiased;"><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;text-size-adjust:none;-webkit-font-smoothing:antialiased;outline:0px;"><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;text-size-adjust:none;-webkit-font-smoothing:antialiased;transition:left 300ms ease;"><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;text-size-adjust:none;-webkit-font-smoothing:antialiased;opacity:1;"><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;text-size-adjust:none;-webkit-font-smoothing:antialiased;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; word-wrap: break-word; text-size-adjust: 100%; overflow: visible;">
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">在Android系统，线程主要分为主线程和子线程，主线程处理和界面相关的事情，而子线程一般用于执行耗时操作。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">在Android中，线程的形态有很多种：</span></span><ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px; list-style-type: lower-roman;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">AsyncTask封装了线程池和Handler。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">HandlerThread是具有消息循环的线程，内部可以使用handler</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">IntentService是一种Service，内部采用HandlerThread来执行任务，当任务执行完毕后IntentService会自动退出。由于它是一种Service，所以不容易被系统杀死</span></span></li></ol></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">操作系统中，线程是操作系统调度的最小单元，同时线程又是一种受限的系统资源，其创建和销毁都会有相应的开销。同时当系统存在大量线程时，系统会通过时间片轮转的方式调度每个线程，<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">因此线程不可能做到绝对的并发，除非线程数量小于等于CPU的核心数</strong>。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">频繁创建销毁线程不明智，使用线程池是正确的做法。线程池会缓存一定数量的线程，通过线程池就可以避免因为频繁创建和销毁线程所带来的系统开销。</span></span></li></ol>
<h2 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.1 主线程和子线程</span></span></span></h2>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">主线程主要处理界面交互逻辑，由于用户随时会和界面交互，所以主线程在任何时候都需要有较高响应速度，则不能执行耗时的任务；</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">android3.0开始，网络访问将会失败并抛出NetworkOnMainThreadException这个异常，这样做是为了避免主线程由于被耗时操作所阻塞从而现ANR现象</span></span></li></ol>
<h2 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.2 Android中的线程形态</span></span></span></h2>
<h3 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.2.1 AsyncTask</span></span></span></h3>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">三个参数（都可为Void)：executeOnExecutor()</span></span><ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px; list-style-type: lower-roman;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">Params：参数</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">Progress：执行进度</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">Result：返回值</span></span></li></ol></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">四个方法 ：executeOnExecutor()</span></span><ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px; list-style-type: lower-roman;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>onPreExecute()<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">主线程执行，异步方法执行前调用。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>doInBackground(Params...params)<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">线程池中执行，用于执行异步任务；在方法内部用publishProgress 来更新任务进度。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>onProgressUpdate(Progress...value)<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">主线程执行，后台任务进度状态改变时被调用。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>onPostExecute(Result result)<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">主线程执行，异步任务执行之后被调用</span></span></li></ol></li></ol>
<p style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; position: relative;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">执行顺序： onPreExecute-&gt;doInBackground-&gt;onPostExecute 如果取消了异步任务，会回调onCancelled()，onPostExecute则不会被调用</span></span></p>
<p style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; position: relative;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">AsyncTask的类必须在主线程加载，Android4.1及以上已经被系统自动完成了；<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">AsyncTask对象必须在主线程创建</strong>；execute方法需要在UI线程调用；一个AsyncTask对象只能调用一次；Android1.6之前串行执行，Android1.6采用线程池并行处理任务，Android3.0开始，又采用一个线程来串行执行任务，但也可以通过</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>executeOnExecutor()<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">方法来并行执行任务。</span></span></p>
<h3 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.2.2 AsyncTask的工作原理</span></span></span></h3>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">AsyncTask中有两个线程池（</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>SerialExecutor<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">和</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>THREAD_POOL_EXECUTOR<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">）和一个</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>InternalHandler<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">，其中线程池SerialExecutor用于任务排队，THREAD_POOL_EXECUTOR用于真正执行任务，InternalHandler用于将执行环境切换到主线程。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><div style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; position: relative;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">AsyncTask的排队过程：系统首先会把AsyncTask的Params参数封装成FutureTask对象，它充当Runnable的作用，接下来这个FutureTask会交给SerialExecutor的</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>execute()<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">方法处理，execute()方法首先会把FutereTask对象插入到任务队列</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>mTasks<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">中去；如果没有正在活动的AsyncTask任务，就会执行下一个AsyncTask任务；同时当一个AsyncTask任务执行完成后，AsyncTask会继续执行其他任务直到所有任务都执行为止，可以看出默认情况，AsyncTask是<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">串行执行</strong>的（Android3.0后）。</span></span></div></li></ol><div style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><div><img alt="这里写图片描述" src="https://user-gold-cdn.xitu.io/2017/6/2/745b5ef8a7b305b12ce98b86a301f6f8?imageView2/0/w/1280/h/960" style="height: auto;"></img></div><div style="text-align: center"><span style="color: rgb(51, 51, 51);font-family:gotham, helvetica, arial, sans-serif;font-size:14px;"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">AsyncTask 工作流程图</span></span></div></div>
<h3 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.2.3 HandlerThread</span></span></span></h3>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">HandlerThread继承了Thread,是一种可以使用Handler的Thread</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">在run方法中通过</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>looper.prepare()<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">来开启消息循环，这样就可以在HandlerThread中创建Handler了</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">外界可以通过一个Handler的消息方式来通知HandlerThread来执行具体任务；确定不使用之后，可以通过</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>quit<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">或</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>quitSafely<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">方法来终止线程执行</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">具体使用场景是IntentService</span></span></li></ol>
<h3 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.2.4 IntentService</span></span></span></h3>
<p style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; position: relative;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">IntentSercie是一种特殊的Service，<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">继承了Service并且是抽象类，任务执行完成后会自动停止，优先级远高于普通线程，适合执行一些高优先级的后台任务</strong>；
IntentService封装了</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>HandlerThread<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">和</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>Handler<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code></p>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>onCreate<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">方法自动创建一个HandlerThread</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">然后用它的Looper构造了一个Handler对象</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>mServiceHandler<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">，这样￼通过mServiceHandler发送的消息都会在HandlerThread执行；</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">IntentServiced的</span></span><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>onHandlerIntent<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">方法是一个抽象方法，需要在子类实现，onHandlerIntent方法执行后，stopSelt(int startId)就会停止服务，<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">如果存在多个后台任务，执行完最后一个stopSelf(int startId)才会停止服务</strong>。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="color: rgb(51, 51, 51);">由于每执行一个后台任务就必须启动一次 IntentService，而 IntentService 内部则通过消息的方式向 HandlerThread 请求执行任务，Handler 中的 Looper 是顺序处理消息的，这就意味着 IntentService 也是顺序执行后台任务的。</span></span></li></ol>
<h2 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.3 Android线程池</span></span></span></h2>
<p style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">优点：</span></span></p>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">重用线程池的线程，减少线程创建和销毁带来的<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">性能开销</strong></span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">控制线程池的<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">最大并发数</strong>，避免大量线程互相抢系统资源导致阻塞</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">提供<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">定时执行和间隔循环执行功能</strong></span></span></li></ol>
<h3 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.3.1 ThreadPoolExecutor（熟悉后可自定义线程池）</span></span></span></h3>
<p style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; position: relative;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">Executor是一个接口，线程池的具体实现在ThreadPoolExecutor；它提供了一系列的参数来配置线程池；Android的线程池 大部分都是通 过Executor提供的工厂方法创建的</span></span></p>
<h4 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">1. ThreadPoolExecutor常见构造参数</span></span></h4>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">corePoolSize： 线程池的核心线程数，默认情况下，核心线程会一直存活(设置了超时机制除外， allowCoreThreadTimeOut属性为true时开启）</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">maxinmumPoolSize： 线程池能容纳的最大线程数，当活动的线程达到这个数值之后，后续新任务会被阻塞</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">keepAliveTime： 非核心线程闲置的超时时长，超过这个时长，非核心线程就会被回收,当allowCoreThreadTimeOut为true时，keepAliveTime同样作用于核心线程。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">unit：keepAliveTime的时间单位，这是一个枚举，常用有TimeUnit.MILLISECONDS(毫秒)、TimeUnit.SECONDS（秒）、TimeUnit.MINUTES(分钟)</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">workQueue： 线程池中的任务队列，通过execute方法提交的Runnable对象会存储在这个参数中</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">threadFactory： 线程工厂，为线程池提供创建线程的功能，是个接口，提供Thread newThread(Runnable r)方法</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">RejectedExecutionHandle：当线程池无法执行新任务时，可能由于线程队列已满或无法成功执行任务，这时候 ThreadPoolExecutor会调用handler的 rejectedExecution的方法，默认会抛出RejectedExecutionException</span></span></li></ol>
<h4 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">2. ThreadPoolExecutor执行任务大致遵循如下规则:</span></span></h4>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">如果线程池中的线程数量未达到核心线程的数量，那么会<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">直接启动一个核心线程来执行任务</strong></span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">如果线程池中的线程数量已经达到或超过核心线程数量，那么任务会<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">被插入到任务队列中排队等待执行</strong></span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">如果步骤2中无法将任务插入到任务队列中，往往是因为任务队列已满，这个时候如果线程数量未达到线程池规定的最大值，那么会立刻<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">启动一个非核心线程来执行任务</strong></span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">如果步骤3中线程数量达到线程池规定的最大值，<strong style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; font-weight: 700;">线程池会拒绝执行任务</strong>，并会调用RejectedExecutionHandler的rejectedExecution方法来通知调用者</span></span></li></ol>
<h4 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">3. AsyncTask的THREAD_POOL_EXECUTOR线程池配置:</span></span></h4>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px 0px 0.85em;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">核心线程数等于CPU核心数+1</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">线程池最大线程数为CPU核心数的2倍+1</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">核心线程无超时机制，非核心线程的闲置超时时间为1秒</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">任务队列容量是128</span></span></li></ol>
<h3 style="margin-top: 1.275em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; break-after: avoid; margin-bottom: 0.85em; font-weight: 700; widows: 3; orphans: 3;"><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><span style="font-size: 14px;">11.3.2 常见的4个线程池</span></span></span></h3>
<ol style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box; padding: 0px 0px 0px 2em; margin: 0px;"><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>FixedThreadPool<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">：线程数量固定的线程池，当所有线程都处于活动状态时，新任务会处于等待状态，只有核心线程并且不会回收（无超时机制），能快速的响应外界请求。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>CachedThreadPool<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">：线程数量不定的线程池，最大线程数为Integer.MAX_VALUE(相当于任意大),当所有线程都处于活动状态时，会创建新线程来处理任务；线程池的空闲进程超时时长为60秒，超过就会被回收；任何任务都会被立即执行，适合执行大量的耗时较少的任务。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>ScheduledThreadPool<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">：核心线程数量固定，非核心线程数量无限制，非核心线程闲置时会被立刻回收，用于执行定时任务和具有固定周期的重复任务。</span></span></li><li style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><code style="padding: 0.2em; -webkit-font-smoothing: antialiased; text-size-adjust: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; direction: ltr; margin: 0px; border: none; color: inherit; background-color: rgb(247, 247, 247); break-inside: avoid; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;"><span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span>SingleThreadExecutor<span style="font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; direction: ltr; color: inherit; letter-spacing: -0.2em;"> </span></code><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">：只有一个核心线程，所有任务都在这个线程中串行执行，不需要处理线程同步问题</span></span></li></ol><div style="-webkit-tap-highlight-color: transparent; text-size-adjust: none; -webkit-font-smoothing: antialiased; box-sizing: border-box;"><div><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><br/></span></div><div><hr/></div><div><span style="font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;"><br/></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-family: &quot;Helvetica Neue&quot;;">参考阅读：<a href="https://app.yinxiang.com/shard/s2/nl/18191028/90c4a715-887f-49a8-bb8f-24a635c4287a?title=Android%20%E7%BA%BF%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0">Android 线程和线程池 - 掘金</a></span></span></div></div>

                                
                                </div></div></div></div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 